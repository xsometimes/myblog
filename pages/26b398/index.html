<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Canvas性能优化的几种方案 | Passerby&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/myblog/assets/css/0.styles.9e02c2dd.css" as="style"><link rel="preload" href="/myblog/assets/js/app.b358d607.js" as="script"><link rel="preload" href="/myblog/assets/js/2.09b68ebe.js" as="script"><link rel="preload" href="/myblog/assets/js/17.5e0b2698.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.0e44db1b.js"><link rel="prefetch" href="/myblog/assets/js/11.7ddcdaf0.js"><link rel="prefetch" href="/myblog/assets/js/12.e5787108.js"><link rel="prefetch" href="/myblog/assets/js/13.b1623188.js"><link rel="prefetch" href="/myblog/assets/js/14.5255ca2d.js"><link rel="prefetch" href="/myblog/assets/js/15.b3366763.js"><link rel="prefetch" href="/myblog/assets/js/16.77f1569b.js"><link rel="prefetch" href="/myblog/assets/js/18.3202f619.js"><link rel="prefetch" href="/myblog/assets/js/19.1347ac4b.js"><link rel="prefetch" href="/myblog/assets/js/20.936c0c3a.js"><link rel="prefetch" href="/myblog/assets/js/21.92a26668.js"><link rel="prefetch" href="/myblog/assets/js/22.d0790825.js"><link rel="prefetch" href="/myblog/assets/js/23.09d23156.js"><link rel="prefetch" href="/myblog/assets/js/24.4e9f2e0f.js"><link rel="prefetch" href="/myblog/assets/js/25.4909b58f.js"><link rel="prefetch" href="/myblog/assets/js/26.c376b228.js"><link rel="prefetch" href="/myblog/assets/js/27.b6fd6b20.js"><link rel="prefetch" href="/myblog/assets/js/28.d53f9176.js"><link rel="prefetch" href="/myblog/assets/js/29.5a991d1b.js"><link rel="prefetch" href="/myblog/assets/js/3.97ced9ed.js"><link rel="prefetch" href="/myblog/assets/js/30.9c693220.js"><link rel="prefetch" href="/myblog/assets/js/31.eef9cede.js"><link rel="prefetch" href="/myblog/assets/js/4.f2947469.js"><link rel="prefetch" href="/myblog/assets/js/5.36c134fb.js"><link rel="prefetch" href="/myblog/assets/js/6.c939d93e.js"><link rel="prefetch" href="/myblog/assets/js/7.dbfb8ce8.js"><link rel="prefetch" href="/myblog/assets/js/8.495172de.js"><link rel="prefetch" href="/myblog/assets/js/9.0dd6c2aa.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.9e02c2dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">Passerby's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><!----> <!---->  <ul class="sidebar-links"><li><a href="/myblog/pages/9d73aa/" class="sidebar-link">react hooks学习笔记</a></li><li><a href="/myblog/pages/e12590/" class="sidebar-link">indexedDB 学习</a></li><li><a href="/myblog/pages/0429b9/" class="sidebar-link">geojson</a></li><li><a href="/myblog/pages/ce0cb8/" class="sidebar-link">react hooks</a></li><li><a href="/myblog/pages/420644/" class="sidebar-link">调度器设计：eventloop、异步更新等相关</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/myblog/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><a href="/myblog/categories/?category=%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="分类" data-v-33863c7e>学习笔记</a></li> <!----> <!----></ul> <div class="info" data-v-33863c7e><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2020-12-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          Canvas性能优化的几种方案
        </h1> <!----> <div class="theme-vdoing-content content__default"><p>简单的笔记。详细可见月影大佬的<a href="https://time.geekbang.org/column/article/279075" target="_blank" rel="noopener noreferrer">29 | 怎么给Canvas绘制加速？（from 跟月影学可视化）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>影响Canvas性能的两大因素分别是图形的数量和图形的大小。它们都会直接影响绘图指令，一个决定了绘图指令的多少，另一个决定了绘图指令的执行时间。通常来说，绘图指令越多、执行时间越长，渲染效率就越低，性能也就越差。<br>因此，我们想要对Canvas性能进行优化，最重要的就是优化渲染效率。</p></blockquote> <h2 id="手段一-优化canvas指令"><a href="#手段一-优化canvas指令" class="header-anchor">#</a> 手段一：优化Canvas指令</h2> <h3 id="_1-1-将渲染阶段的开销转嫁到计算阶段上"><a href="#_1-1-将渲染阶段的开销转嫁到计算阶段上" class="header-anchor">#</a> 1.1 将渲染阶段的开销转嫁到计算阶段上</h3> <h3 id="_1-2-换一种方式实现"><a href="#_1-2-换一种方式实现" class="header-anchor">#</a> 1.2 换一种方式实现</h3> <p>假设我们要在一个600*600的画布上，实现一些位置随机的多边形，并且不断刷新这些图形和位置，效果如下：</p> <p align="center"><img src="/myblog/assets/img/canvas20210524001.4e226d73.gif" alt="canvas20210524001"></p> <p>实现思路可以分为4步：创建多边形的顶点，根据顶点绘制图形，生成随机多边形，执行绘制：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// 步骤1：创建正多边形，返回顶点</span>
<span class="token keyword">function</span> <span class="token function">regularShape</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> edges <span class="token operator">=</span> <span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> delta <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> edges<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edges<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> theta <span class="token operator">=</span> i <span class="token operator">*</span> delta<span class="token punctuation">;</span>
    points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token operator">+</span> r <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">,</span> y <span class="token operator">+</span> r <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> points<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 步骤2：根据顶点绘制图形</span>
<span class="token keyword">function</span> <span class="token function">drawShape</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> points</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'black'</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token operator">...</span>points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token operator">...</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  context<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 多边形类型，包括正三角形、正四边形、正五边形、正六边形和正100边形</span>
<span class="token keyword">const</span> shapeTypes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token comment">// 步骤3 &amp;&amp; 4：执行绘制</span>
<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> shapeTypes<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> shapeTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token function">regularShape</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
      Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drawShape</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>这里存在一个问题，对于一个100边形来说，它的顶点数量非常多，所以Canvas需要执行的绘图指令也会非常多，绘制多个100边形自然会造成性能问题。因此，我们优化的重点就是，减少绘制100边形的绘图指令的数量。而我们知道，对于半径为10的小圆形来说，正100变形已经完全是正圆形了，所以我们可以用arc指令来代替for循环。</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">TAU</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// 对于很多条边，如100的正100变形，代码执行为：</span>
<span class="token comment">// 画圆</span>
ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">TAU</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="手段二-使用缓存"><a href="#手段二-使用缓存" class="header-anchor">#</a> 手段二：使用缓存</h2> <h3 id="_2-1-离屏canvas"><a href="#_2-1-离屏canvas" class="header-anchor">#</a> 2.1 离屏Canvas</h3> <p>因为Canvas的性能瓶颈主要在绘图指令方面，若我们能将图形缓存下来，保存到离屏Canvas（offscreen Canvas）中，然后在绘制的时候作为图形来渲染，那么我们就可以将绘制顶点的绘图指令变成直接通过drawImage指令来绘制图像，而且也不需要fill方法来填充图形，这样性能就会有大幅度的提升。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 步骤1：先实现一个创建缓存的函数：</span>

<span class="token keyword">function</span> <span class="token function">createCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shapeTypes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建离屏Canvas缓存图形</span>
    <span class="token keyword">const</span> cacheCanvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffscreenCanvas</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将图形绘制到离屏Canvas对象上</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> shapeTypes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> cacheCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'black'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token function">regularShape</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">drawShape</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">TAU</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      context<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ret<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cacheCanvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将离屏Canvas数组（缓存对象）返回</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 步骤2：一次性创建缓存，直接通过缓存来绘图</span>

<span class="token keyword">const</span> shapes <span class="token operator">=</span> <span class="token function">createCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> shape <span class="token operator">=</span> shapes<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> shapeTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>shape<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>这样，我们就通过缓存渲染，把原本数量非常多的绘图指令优化成了只有drawImage的一条执行，让渲染帧率达到了60fps，从而大大提升了性能。</p> <h3 id="_2-1-缓存的局限性"><a href="#_2-1-缓存的局限性" class="header-anchor">#</a> 2.1 缓存的局限性</h3> <ul><li><p>若我们需要绘制的图形状态（不同形状、颜色等）非常多的话，那将它们都缓存起来，就需要创建大量的离屏Canvas对象。这本身对内容消耗就非常大，有可能反而降低了性能。</p></li> <li><p>缓存使用于图形状态本身不变的图形元素，（如固定的几何图形，每次刷新只需要更新它的transform，这样的图形比较适合用缓存）。若是经常发生状态改变的图形元素，那么缓存就必须一致更新，缓存更新本身也是绘图过程。因此，这种情况下，采用缓存根本起不到减少绘图指令的作用，反而因为增加了一条drawImage指令产生了更大的开销。</p></li> <li><p>严格来说，从缓存绘制和直接用绘图指令绘制还是有区别的，尤其是在fillText渲染文字或者我们绘制一个图形有较大缩放scale的时候。因为不使用缓存直接绘制的是矢量图，而通过缓存drawImage绘制出的则是位图，所以缓存绘制的图形，在清晰度上可能不是很好。</p></li></ul> <h3 id="_2-3-getimagedata-和-putimagedata"><a href="#_2-3-getimagedata-和-putimagedata" class="header-anchor">#</a> 2.3 getImageData 和 putImageData</h3> <p>getImageData 和 putImageData 这一对API在这方面挺好用的，前者可以将某个Canvas上的某一块区域保存为ImageData，后者可以将ImageData对象重新绘制到Canvas上面。但实际上putImageData是一项开销即为巨大的操作，不适合在每一帧里调用。</p> <h2 id="手段三-分层canvas"><a href="#手段三-分层canvas" class="header-anchor">#</a> 手段三：分层Canvas</h2> <p>上述两种手段是操作Canvas上所有元素来优化性能的，但有时候，我们要绘制的元素很多，其中大部分元素状态是不变的，只有一小部分有变化。这种场景下，考虑分层Canvas。</p> <p>分层Canvas的出发点是，动画中的每种元素（层），对渲染和动画的要求是不一样的。对很多游戏而言，主要角色变化的频率和幅度是很大的，而背景变化的频率或幅度则相对较小（基本不变，或缓慢变化，或仅在某些时机变化）。很明显，我们需要很频繁地更新和重绘人物，但是对于背景，我们也许只需要绘制一次，也许只需要每隔200ms才重绘一次，绝对没有必要每16ms就重绘一次。</p> <p>使用上，分层Canvas也很简单，我们需要做的，仅仅是生成多个Canvas实例，把它们重叠放置，每个Canvas使用不同的z-index来定义堆叠的次序。然后仅在需要绘制该层的时候（也许是“永不”）进行重绘。</p> <p>使用分层Canvas所绘制的图形最好满足两个条件：一是有大量静态的图形元素不需要重新绘制，二是动态和静态图形元素绘制顺序是固定的。</p> <h2 id="手段四-局部重绘"><a href="#手段四-局部重绘" class="header-anchor">#</a> 手段四：局部重绘</h2> <p>局部重绘，即不需要清空Canvas的全局领域，而是根据运动的元素的范围类清空部分区域。</p> <p>我们可用Canvas上下文的clearRect方法控制要刷新的动态区域，只对这些区域记性擦除然后重绘。</p> <p>要注意的是，动态区重绘的时候，若有静态元素跨越动态和静态区域范围，重回时也会被破坏。此时，我们可以采取Canvas上下文的clip方法（剪切区域），它是Canvas中由路径所定义的一块区域，浏览器会将所有的绘图操作都限制在本区域内执行。（这也意味着在剪辑区域以外进行绘制是没效果的）</p> <p>这种固定区域的局部重绘使用起来不难，但有时候我们不知道具体的动态区域究竟多大。这个时候，我们可以使用动态计算要重绘区域的技术，它也被称为<strong>脏区检测</strong>。它的基本原理是根据动态元素的<strong>包围盒</strong>（<strong>凸包</strong>算法跟这相关？大佬本文中没提到，mark），动态计算出需要重绘的范围。细节问题可以学习<a href="https://juejin.cn/post/6844904103231881229" target="_blank" rel="noopener noreferrer">蚂蚁金服AntV<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="手段五-优化滤镜"><a href="#手段五-优化滤镜" class="header-anchor">#</a> 手段五：优化滤镜</h2> <p>Canvas支持很多常用的滤镜（一种对图形像素进行处理的方法），但是性能开销很大。</p> <p>因此我们的优化手段为：采用类似后期处理通道的做法，先将图形以不使用滤镜的方式绘制到一个离屏Canvas上，然后直接将这个离屏Canvas以图片方式绘制到要显示的画布上，在这次绘制的时候采用滤镜。这样，我们就把大量滤镜绘制的过程缩减为对一张图片使用一次滤镜了，提高帧率。总之，想要达到比较好的性能，我们要尽量合并图形应用相同滤镜的过程。</p> <h2 id="手段六-多线程渲染"><a href="#手段六-多线程渲染" class="header-anchor">#</a> 手段六：多线程渲染</h2> <p>所谓阻塞，可以理解为不间断运行时间超过 16ms 的 JavaScript 代码，以及“导致浏览器花费超过 16ms 时间进行处理”的 JavaScript 代码。即使在没有什么动画的页面里，阻塞也会被用户立刻察觉到：阻塞会使页面上的对象失去响应——按钮按不下去，链接点不开，甚至标签页都无法关闭了。而在包含较多 JavaScript 动画的页面里，阻塞会使动画停止一段时间，直到阻塞恢复后才继续执行。如果经常出现“小型”的阻塞（比如上述提及的这些优化没有做好，渲染一帧的时间超过 16ms），那么就会出现“丢帧”的情况。</p> <p>偶尔的且较小的阻塞是可以接收的，频繁或较大的阻塞是不可以接受的。也就是说，我们需要解决两种阻塞：</p> <ul><li><ol><li>频繁（通常较小）的阻塞。其原因主要是过高的渲染性能开销，在每一帧中做的事情太多。</li></ol></li> <li><ol start="2"><li>较大（虽然偶尔发生）的阻塞。其原因主要是运行复杂算法、大规模的 DOM 操作等等。</li></ol></li></ul> <p>对前者，我们应当仔细地优化代码，有时不得不降低动画的复杂（炫酷）程度。而对于后者，主要有以下两种优化的策略：使用 Web Worker，在另一个线程里进行计算；将任务拆分为多个较小的任务，插在多帧中进行。</p> <p>Web Worker 是好东西，性能很好，兼容性也不错。浏览器用另一个线程来运行 Worker 中的 JavaScript 代码，完全不会阻碍主线程的运行。动画（尤其是游戏）中难免会有一些时间复杂度比较高的算法，用 Web Worker 来运行再合适不过了。参考可见<a href="https://github.com/akira-cn/graphics/blob/master/performance_canvas/random_shapes_worker.html" target="_blank" rel="noopener noreferrer">示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/myblog/tags/?tag=canvas" title="标签">#canvas</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/myblog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/myblog/pages/fe78bc/"><div>扁平数组和树形结构的相互转换</div></a> <span>06-14</span></dt></dl><dl><dd>02</dd> <dt><a href="/myblog/pages/ce0cb8/"><div>react hooks</div></a> <span>06-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/myblog/pages/9c8a34/"><div>手写Promise</div></a> <span>06-03</span></dt></dl> <dl><dd></dd> <dt><a href="/myblog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2021
    <span>passerby | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.b358d607.js" defer></script><script src="/myblog/assets/js/2.09b68ebe.js" defer></script><script src="/myblog/assets/js/17.5e0b2698.js" defer></script>
  </body>
</html>